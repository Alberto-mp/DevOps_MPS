name: Java Tests and SonarCloud Analysis in Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-and-analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Run Tests and SonarCloud in Docker
      run: |
        docker run --rm \
          -v "$PWD":/usr/src/app \
          -w /usr/src/app \
          maven:3.8.5-openjdk-17 bash -c "
            mvn clean verify &&
            curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip &&
            unzip sonar-scanner.zip &&
            ./sonar-scanner-4.8.0.2856-linux/bin/sonar-scanner \
              -Dsonar.projectKey=Alberto-mp_DevOps_MPS \
              -Dsonar.organization=alberto-mp \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
              -Dsonar.sources=src \
              -Dsonar.tests=src/test \
              -Dsonar.java.binaries=target/classes"
